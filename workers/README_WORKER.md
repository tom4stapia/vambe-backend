# Vambe AI Worker - Sistema de Clasificaci√≥n Inteligente

## üìÅ Estructura Modular Organizada

```
workers/
‚îú‚îÄ‚îÄ üìÅ core/                   # üèóÔ∏è Componentes principales
‚îÇ   ‚îú‚îÄ‚îÄ database.py           # üóÑÔ∏è Cliente PostgreSQL con ORM
‚îÇ   ‚îú‚îÄ‚îÄ database_config.py    # ‚öôÔ∏è Configuraci√≥n SQLAlchemy
‚îÇ   ‚îú‚îÄ‚îÄ redis_client.py       # üî¥ Cliente Redis con task tracking
‚îÇ   ‚îú‚îÄ‚îÄ tasks.py              # üéØ Tareas de Celery
‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ üìÅ services/              # üîß Servicios de negocio
‚îÇ   ‚îú‚îÄ‚îÄ openai_classification_service.py  # üß† Servicio de clasificaci√≥n con OpenAI GPT-4o-mini
‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ üìÅ models/                # üìã Modelos de datos
‚îÇ   ‚îú‚îÄ‚îÄ models.py             # Modelos Pydantic
‚îÇ   ‚îú‚îÄ‚îÄ database_models.py    # Modelos SQLAlchemy ORM
‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ üìÅ enums/                 # üè∑Ô∏è Enumeraciones
‚îÇ   ‚îú‚îÄ‚îÄ enums.py              # Enumeraciones del sistema
‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ üìÅ config/                # ‚öôÔ∏è Configuraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ config.py             # Configuraci√≥n de la aplicaci√≥n
‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ app.py                    # üå∏ Aplicaci√≥n Celery
‚îú‚îÄ‚îÄ worker.py                 # üéØ Worker de Celery
‚îú‚îÄ‚îÄ __init__.py               # üì¶ Paquete Python principal
‚îú‚îÄ‚îÄ requirements.txt          # üìã Dependencias
‚îú‚îÄ‚îÄ Dockerfile               # üê≥ Docker
‚îî‚îÄ‚îÄ README_WORKER.md         # üìñ Esta documentaci√≥n
```

## üèóÔ∏è Arquitectura con Celery

### **1. Aplicaci√≥n Celery (`app.py`)**
- **Responsabilidad**: Configuraci√≥n y setup de Celery
- **Funciones**:
  - Configurar broker (Redis)
  - Configurar result backend
  - Auto-descubrir tareas
  - Configurar routing y colas

### **2. Tareas de Celery (`core/tasks.py`)**
- **Responsabilidad**: Definir tareas as√≠ncronas
- **Funciones**:
  - `classify_meeting_task`: Procesar clasificaci√≥n de reuniones con OpenAI
  - `health_check_task`: Verificar salud del sistema
  - Manejo de estados y reintentos
  - Integraci√≥n con servicios modulares
  - **Nuevo**: Tracking de task IDs personalizados

### **3. Worker de Celery (`worker.py`)**
- **Responsabilidad**: Ejecutar worker de Celery
- **Funciones**:
  - Inicializar conexiones
  - Iniciar worker con configuraci√≥n
  - Manejar concurrencia
  - Procesar colas espec√≠ficas

### **4. Servicios Modulares**
- **Cliente Redis (`redis_client.py`)**: Comunicaci√≥n con Redis + task status tracking
- **Cliente Base de Datos (`database.py`)**: Comunicaci√≥n con PostgreSQL usando SQLAlchemy ORM
- **Configuraci√≥n DB (`database_config.py`)**: Configuraci√≥n y gesti√≥n de sesiones SQLAlchemy
- **Servicio de Clasificaci√≥n OpenAI (`openai_classification_service.py`)**: Clasificaci√≥n inteligente con GPT-4o-mini

### **5. Modelos de Datos**
- **Modelos Pydantic (`models.py`)**: Validaci√≥n y serializaci√≥n de datos
- **Modelos SQLAlchemy (`database_models.py`)**: Mapeo ORM de la base de datos existente

## üîÑ Flujo de Trabajo con Celery

```mermaid
graph TD
    A[API/Client] --> B[Generate Custom Task ID]
    B --> C[Store Task Mapping in Redis]
    C --> D[Enqueue Task with Custom ID]
    D --> E[Redis Queue]
    E --> F[Celery Worker]
    F --> G[Execute Task]
    G --> H[Update Task Status]
    H --> I[Process OpenAI Classification]
    I --> J[Save to Database]
    J --> K[Store Result in Redis]
    K --> L[Update Final Task Status]
    L --> M[Task Complete]
```

## üöÄ Uso con Docker Compose (Recomendado)

### **Inicio Autom√°tico**
```bash
# Iniciar todos los servicios (incluye migraciones y seeds autom√°ticos)
docker compose up --build

# Ver logs del worker
docker compose logs -f workers
```

### **Verificaci√≥n del Sistema**
```bash
# Health check de la API
curl http://localhost:3000/health

# Health check de workers
curl http://localhost:3000/api/v1/workers/health

# Ver estad√≠sticas del sistema
curl http://localhost:3000/api/v1/workers/stats
```

## üß† Sistema de Clasificaci√≥n con OpenAI

### **Servicio de Clasificaci√≥n Inteligente**
El worker utiliza OpenAI GPT-4o-mini para analizar transcripciones de reuniones y proporcionar clasificaciones precisas y contextuales.

### **Caracter√≠sticas del Servicio OpenAI**
- **üéØ Modelo Avanzado**: Utiliza GPT-4o-mini para mejor precisi√≥n
- **üìä Clasificaci√≥n Completa**: Analiza 12 categor√≠as diferentes
- **üòä An√°lisis de Sentimiento**: Detecta el tono y actitud del cliente
- **üìù Extracci√≥n de Temas**: Identifica temas clave discutidos en espa√±ol
- **‚úÖ Items de Acci√≥n**: Extrae compromisos y pr√≥ximos pasos
- **üîÑ Reintentos Autom√°ticos**: Manejo robusto de errores de API
- **‚ö° Fallback Inteligente**: Sistema de respaldo si OpenAI falla

### **Categor√≠as de Clasificaci√≥n**

#### **Informaci√≥n del Negocio**
- **business_sector**: retail, ecommerce, financial_services, insurance, healthcare, pharmaceuticals, energy, utilities, telecom, transportation_logistics, tourism_hospitality, education, government, agroindustry, manufacturing, construction, mining, media_entertainment, software_saas, real_estate, food_beverages, cpg, automotive, ngo, human_resources
- **company_size**: small, medium, large, enterprise
- **region**: latam_south, latam_north, north_america, europe, asia, africa, oceania

#### **Origen y Producto**
- **lead_source**: referral, seo, sem_ads, email, event, partner, outbound_call, cold_email, linkedin, instagram, facebook, webchat, pr, marketplace
- **vambe_product**: mercur (chats+integrations), iris (fast/simple), ads (attribution/marketing), axis (only integrations)

#### **An√°lisis de la Oportunidad**
- **use_case**: lead_scoring, customer_segmentation, churn_prediction, marketing_attribution, campaign_optimization, demand_forecasting, voice_analytics, operations_automation, real_time_reporting, dw_modernization, fraud_detection, conversational_support
- **primary_pain_point**: lack_visibility, slow_reporting, low_conversion, high_churn, high_advertising_costs, difficult_integrations, regulatory_compliance, dispersed_data, saturated_support, scalability

#### **Contexto de la Reuni√≥n**
- **urgency**: true/false (basado en deadlines o presi√≥n temporal)
- **decision_maker_role**: ceo, coo, cto, cmo, cio, cfo, head_data, head_ops, head_sales, product_owner, it_manager, analyst, founder
- **purchase_stage**: discovery, negotiation, closure
- **language**: es, en
- **lost_client_bad_meeting**: true/false (basado en confusi√≥n o insatisfacci√≥n)

#### **An√°lisis de Contenido**
- **sentiment**: positive, neutral, negative
- **confidence_score**: 0.1 - 0.95
- **key_topics**: Lista de 2-5 temas espec√≠ficos en espa√±ol
- **action_items**: Lista de 1-3 acciones espec√≠ficas en espa√±ol
- **next_steps**: Descripci√≥n concisa del siguiente paso acordado
- **summary**: Resumen de 1-2 oraciones en espa√±ol

### **Prompt de Clasificaci√≥n Avanzado**
El servicio utiliza un prompt especializado que:
- Analiza cada categor√≠a del sistema individualmente
- Selecciona EXACTAMENTE UNA categor√≠a de cada enum (no inventa nuevas)
- Proporciona an√°lisis espec√≠ficos para TODAS las categor√≠as
- NUNCA devuelve null - siempre proporciona an√°lisis o valores por defecto
- Evita respuestas gen√©ricas como "OTHER"
- Usa √∫nicamente los valores exactos de las categor√≠as definidas
- Calcula puntuaciones de confianza
- Extrae informaci√≥n estructurada en formato JSON
- Proporciona res√∫menes concisos y accionables en espa√±ol

## üîß Sistema de Tracking de Tareas

### **Task ID Personalizado**
- **Generaci√≥n**: La API genera UUIDs √∫nicos para cada tarea
- **Mapeo**: Almacena mapeo entre task ID y meeting ID en Redis
- **Tracking**: El worker almacena estados usando el task ID personalizado
- **Consulta**: La API consulta estados espec√≠ficos por task ID

### **Estados de Tarea**
- **`processing`**: Tarea en progreso
- **`completed`**: Tarea completada exitosamente
- **`failed`**: Tarea fall√≥
- **`pending`**: Tarea no encontrada o expirada

### **Flujo de Tracking**
1. **API**: Genera task ID personalizado
2. **Redis**: Almacena mapeo task ID ‚Üí meeting ID
3. **Worker**: Procesa tarea y actualiza estado
4. **API**: Consulta estado espec√≠fico por task ID
5. **Resultado**: Retorna estado correcto y resultados

## ‚öôÔ∏è Configuraci√≥n

### **Variables de Entorno**
```bash
# Redis
REDIS_URL=redis://redis:6379/0

# PostgreSQL
POSTGRES_HOST=db
POSTGRES_PORT=5432
POSTGRES_DB=vambe_db
POSTGRES_USER=postgres
POSTGRES_PASSWORD=password

# OpenAI
OPENAI_API_KEY=sk-proj-your-openai-api-key
OPENAI_MODEL=gpt-4o-mini

# Celery
CELERY_BROKER_URL=redis://redis:6379/0
CELERY_RESULT_BACKEND=redis://redis:6379/0
```

### **Dependencias**
```txt
redis==5.0.1
pydantic==2.5.2
python-dotenv==1.0.0
psycopg2-binary==2.9.9
celery==5.3.4
sqlalchemy==2.0.23
openai==1.12.0
httpx==0.25.2
```

## üß™ Pruebas y Monitoreo

### **Prueba de Conexiones**
```bash
# Test Redis
python -c "from core.redis_client import redis_client; redis_client.test_connection()"

# Test Database
python -c "from core.database import db_client; db_client.test_connection()"

# Test OpenAI
python -c "from services.openai_classification_service import openai_classification_service; print('OpenAI service loaded')"
```

### **Comandos Celery √ötiles**
```bash
# Ver workers activos
celery -A app inspect active

# Ver estad√≠sticas
celery -A app inspect stats

# Enviar tarea de prueba
celery -A app call core.tasks.health_check_task

# Ver colas
celery -A app inspect active_queues
```

### **Monitoreo en Tiempo Real**
```bash
# Ver logs del worker
docker compose logs -f workers

# Ver logs de la API
docker compose logs -f api

# Ver logs de Redis
docker compose logs -f redis
```

## üõ†Ô∏è Desarrollo

### **Agregar Nueva Categor√≠a de Clasificaci√≥n**
1. **Actualizar enums**: Agregar nueva categor√≠a en `enums/enums.py`
2. **Actualizar modelo**: Agregar campo en `models/models.py`
3. **Actualizar prompt**: Modificar prompt en `services/openai_classification_service.py`
4. **Actualizar migraci√≥n**: Agregar columna en base de datos
5. **Probar**: Ejecutar clasificaci√≥n de prueba

### **Ejemplo de Nueva Categor√≠a**
```python
# enums/enums.py
class NewCategory(str, Enum):
    OPTION_1 = "option_1"
    OPTION_2 = "option_2"
    OPTION_3 = "option_3"

# models/models.py
class ClassificationResult(BaseModel):
    # ... existing fields ...
    new_category: Optional[str] = None
```

## üéØ Beneficios del Sistema Actualizado

### **Ventajas de la Clasificaci√≥n con IA**
- **üéØ Precisi√≥n**: An√°lisis contextual m√°s preciso que reglas est√°ticas
- **üìà Escalabilidad**: Procesa cualquier volumen de transcripciones
- **üîÑ Consistencia**: Resultados consistentes y objetivos
- **üí° Insights**: Extrae informaci√≥n valiosa autom√°ticamente
- **‚ö° Velocidad**: Procesamiento r√°pido de reuniones
- **üí∞ Costo-Efectivo**: Utiliza GPT-4o-mini optimizado

### **Ventajas del Tracking de Tareas**
- **üîç Visibilidad**: Estado de tareas en tiempo real
- **üéØ Precisi√≥n**: Resultados espec√≠ficos por tarea
- **üîÑ Confiabilidad**: No retorna resultados antiguos
- **üìä Monitoreo**: Estad√≠sticas detalladas del sistema
- **üõ°Ô∏è Robustez**: Manejo de errores y fallbacks

### **Ventajas de la Arquitectura Modular**
- **üîß Mantenibilidad**: Cada m√≥dulo tiene responsabilidad √∫nica
- **üß™ Testabilidad**: Componentes independientes f√°ciles de testear
- **üîÑ Reutilizaci√≥n**: M√≥dulos pueden usarse en otros proyectos
- **üìà Escalabilidad**: F√°cil agregar nuevos m√≥dulos
- **üêõ Debugging**: Errores aislados por m√≥dulo
- **üë• Colaboraci√≥n**: Equipos pueden trabajar en m√≥dulos separados

## üöÄ Mejoras Futuras

### **Clasificaci√≥n de IA**
- **Modelos Avanzados**: Migrar a GPT-4 Turbo o Claude para mejor precisi√≥n
- **Fine-tuning**: Entrenar modelos espec√≠ficos para el dominio de Vambe
- **Validaci√≥n de Resultados**: Sistema de feedback para mejorar clasificaciones
- **Batch Processing**: Optimizar procesamiento en lotes para mayor eficiencia

### **Arquitectura**
- **Serverless**: Migrar a AWS Lambda para mejor escalabilidad
- **ElastiCache**: Implementar AWS ElastiCache for Redis para mejor performance
- **Auto-scaling**: Configurar auto-scaling basado en m√©tricas
- **Monitoring**: Implementar CloudWatch, DataDog o similar

### **Testing y Calidad**
- **Unit Tests**: Cobertura completa de tests unitarios
- **Integration Tests**: Tests de integraci√≥n end-to-end
- **Load Testing**: Tests de carga para validar performance
- **Error Tracking**: Sentry o similar para tracking de errores

---

**Vambe AI Worker** - Sistema de clasificaci√≥n inteligente con OpenAI y tracking de tareas avanzado